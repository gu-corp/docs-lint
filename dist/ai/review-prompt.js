import { readStandardsFile } from './prompt.js';
/**
 * Generate a specification review prompt for chat AI
 * Purpose: "Can engineers implement accurately without confusion from this spec?"
 */
export function generateSpecReviewPrompt(options) {
    const { docsDir, srcDir } = options;
    const sections = [];
    // Get standards
    const standards = readStandardsFile(docsDir);
    // Header
    sections.push(`# 仕様書品質レビュー依頼

**目的**: この仕様書で、エンジニアが迷わず正確に実装できるか？

以下の指示に従って、プロジェクトの仕様書をレビューしてください。

---`);
    // Personas
    sections.push(`## あなたのペルソナ

以下の3つの視点で厳しくレビューしてください：

### 1. シニアSE / アーキテクト
**観点**: 「この仕様で実装できるか？技術的に破綻していないか？」

チェック項目:
- [ ] 技術的に実現可能か（無理な要求がないか）
- [ ] 依存関係が明確か（何に依存し、何が依存するか）
- [ ] 非機能要件（性能、スケーラビリティ）が考慮されているか
- [ ] 外部システムとの連携が明確か
- [ ] データフローに矛盾がないか

### 2. QAエンジニア / テストリード
**観点**: 「この仕様でテストケースを書けるか？合否判定できるか？」

チェック項目:
- [ ] 受け入れ基準が明確か（何をもって「完了」とするか）
- [ ] 境界条件・制限値が具体的な数値で定義されているか
- [ ] 正常系・異常系の期待動作が明記されているか
- [ ] エッジケースが考慮されているか
- [ ] テスト可能な形式で記述されているか

### 3. 新人エンジニア
**観点**: 「読んで理解できるか？迷う箇所がないか？」

チェック項目:
- [ ] 専門用語に説明があるか
- [ ] 曖昧な表現がないか（「適切に」「必要に応じて」「など」）
- [ ] 図表が適切に使われているか
- [ ] 前提知識が明記されているか
- [ ] 読む順序が明確か（どこから読めばいいか）

---`);
    // Standards
    const standardsNote = standards.isDefault
        ? '（G.U.Corp デフォルト標準）'
        : '（プロジェクト固有の標準）';
    sections.push(`## ドキュメント標準規約 ${standardsNote}

<document-standards>
${standards.content}
</document-standards>

---`);
    // Review checklist
    sections.push(`## 具体的なチェックリスト

### 曖昧さチェック

以下の表現を見つけたら指摘してください：

| 曖昧な表現 | 問題点 | 改善例 |
|-----------|-------|-------|
| 「適切に処理する」 | 何が適切か不明 | 「エラーコード E001 を返す」 |
| 「必要に応じて」 | いつ必要か不明 | 「データが100件を超えた場合」 |
| 「など」「等」 | 範囲が不明確 | 全ての項目を列挙する |
| 「できるだけ」「なるべく」 | 基準がない | 「99%以上」「3秒以内」 |
| 「高速に」「迅速に」 | 数値がない | 「100ms以内」 |
| 「ユーザーフレンドリー」 | 主観的 | 具体的なUI要件を記述 |

### 数値・制限値チェック

以下が具体的な数値で定義されているか確認：

- [ ] 文字数制限（最小・最大）
- [ ] 数値範囲（最小・最大）
- [ ] タイムアウト値
- [ ] リトライ回数
- [ ] 同時接続数
- [ ] ファイルサイズ上限
- [ ] レスポンス時間目標

### 異常系チェック

以下のケースが定義されているか確認：

- [ ] 入力値が不正な場合
- [ ] 外部システムがダウンしている場合
- [ ] タイムアウトした場合
- [ ] 認証・認可エラーの場合
- [ ] データが存在しない場合
- [ ] 同時実行・競合の場合

---`);
    // Source code review (if srcDir specified)
    if (srcDir) {
        sections.push(`## 設計と実装の整合性チェック

\`${srcDir}/\` のコードも確認し、仕様書との整合性をチェックしてください：

- [ ] 仕様書に書かれていることが実装されているか
- [ ] 実装されているが仕様書にないものがないか
- [ ] 仕様書と実装で矛盾がないか

---`);
    }
    // Output format
    sections.push(`## 出力形式

### 総合評価

| 項目 | 評価 |
|------|------|
| 実装可能性 | ⭐⭐⭐⭐⭐ (5段階) |
| テスト設計可能性 | ⭐⭐⭐⭐⭐ (5段階) |
| 可読性・理解しやすさ | ⭐⭐⭐⭐⭐ (5段階) |
| **総合判定** | 合格 / 要修正 / 差し戻し |

### 検出された問題

| # | ファイル | 箇所 | 問題種別 | 問題の詳細 | 修正案 |
|---|---------|------|---------|-----------|-------|
| 1 | path/to/file.md | L42 | 曖昧さ/欠落/矛盾 | 具体的な問題 | 具体的な修正案 |

**問題種別**:
- 🔴 **重大**: このままでは実装不可能
- 🟡 **要改善**: 実装はできるが、認識違いが起きる可能性
- 🟢 **軽微**: あると良いが、なくても実装可能

### 良い点

- [良い点を具体的に]

### 実装前に確認すべき質問

仕様書を読んで、以下の点が不明でした。実装前にPMに確認してください：

1. [確認すべき質問1]
2. [確認すべき質問2]

---

**レビューを開始してください。仕様書を厳しくチェックし、「エンジニアが迷わず実装できる品質か」を判定してください。**`);
    return sections.join('\n\n');
}
/**
 * Generate a code review prompt for requirement coverage analysis
 * Purpose: "Is this code production-ready? Written by a professional?"
 */
export function generateCodeReviewPrompt(options) {
    const { docsDir, srcDir, specPatterns, sourcePatterns } = options;
    const sections = [];
    // Header
    sections.push(`# コードレビュー依頼

**目的**:
1. 仕様書通りに実装されているか？
2. プロフェッショナルが書いたコードか？
3. 本番環境にリリースできる品質か？

---`);
    // Targets
    const specPatternsStr = specPatterns?.join(', ') || '**/*REQUIREMENTS*.md, **/*API*.md';
    const sourcePatternsStr = sourcePatterns?.join(', ') || '**/*.ts, **/*.tsx';
    sections.push(`## 対象

- **仕様書**: \`${docsDir}/\` (${specPatternsStr})
- **ソースコード**: \`${srcDir}/\` (${sourcePatternsStr})

---`);
    // Personas
    sections.push(`## あなたのペルソナ

以下の3つの視点で厳しくレビューしてください：

### 1. テックリード / シニアエンジニア
**観点**: 「このコードをマージして大丈夫か？保守できるか？」

チェック項目:
- [ ] 設計パターンが適切か（過剰設計・設計不足がないか）
- [ ] 責務の分離ができているか（SRP違反がないか）
- [ ] 命名が明確か（変数名、関数名、クラス名）
- [ ] コードの重複がないか（DRY原則）
- [ ] 依存関係が適切か（循環参照がないか）
- [ ] 将来の変更に耐えられるか

### 2. セキュリティエンジニア
**観点**: 「脆弱性はないか？攻撃されても大丈夫か？」

チェック項目:
- [ ] **インジェクション**: SQLインジェクション、コマンドインジェクション
- [ ] **XSS**: ユーザー入力のエスケープ
- [ ] **認証・認可**: 適切なアクセス制御
- [ ] **機密情報**: ハードコードされた秘密情報、ログへの出力
- [ ] **入力検証**: 全ての外部入力の検証
- [ ] **CSRF**: 適切なトークン検証

### 3. SRE / 運用担当
**観点**: 「本番で問題が起きたとき、対応できるか？」

チェック項目:
- [ ] **エラーハンドリング**: 例外を握りつぶしていないか
- [ ] **ログ出力**: 調査に必要な情報がログに出ているか
- [ ] **リトライ**: 一時的なエラーに対するリトライ機構
- [ ] **タイムアウト**: 外部呼び出しにタイムアウト設定があるか
- [ ] **監視可能性**: メトリクス、ヘルスチェック
- [ ] **グレースフルシャットダウン**: 終了時の後処理

---`);
    // Spec compliance
    sections.push(`## 仕様適合性チェック

### Step 1: 要件の確認

\`${docsDir}/02-spec/01-requirements/REQUIREMENTS.md\` を読み、以下を確認：

- [ ] FR-XXX形式の全要件をリストアップ
- [ ] 各要件の優先度と実装バージョンを確認
- [ ] 現バージョンで実装すべき要件を特定

### Step 2: 実装状況の確認

各要件について、ソースコードで以下を確認：

| 確認項目 | 詳細 |
|---------|------|
| 機能実装 | 要件の機能が実装されているか |
| エッジケース | 境界値、異常系が処理されているか |
| エラーメッセージ | 仕様書のエラーコードと一致しているか |
| API仕様 | リクエスト/レスポンス形式が一致しているか |

### Step 3: テストの確認

- [ ] 各要件に対応するテストが存在するか
- [ ] 正常系・異常系の両方がテストされているか
- [ ] テストが実際に要件を検証しているか（名前だけでなく内容）

---`);
    // Code quality checklist
    sections.push(`## コード品質チェックリスト

### 即座に修正すべき問題

以下を見つけたら🔴重大として報告：

\`\`\`
❌ ハードコードされたパスワード・APIキー
❌ SQLインジェクション可能なコード
❌ 例外を握りつぶすcatch(e) {}
❌ console.log() のデバッグ出力
❌ TODO/FIXME/HACKコメントの残存
❌ 無限ループの可能性
❌ メモリリークの可能性
❌ 未使用のimport/変数
\`\`\`

### 改善推奨項目

以下を見つけたら🟡要改善として報告：

\`\`\`
⚠️ マジックナンバー（定数化されていない数値）
⚠️ 深いネスト（3段階以上）
⚠️ 長い関数（50行以上）
⚠️ any 型の使用（TypeScript）
⚠️ コメントのない複雑なロジック
⚠️ 重複したコード
\`\`\`

---`);
    // Test coverage requirements
    sections.push(`## テストカバレッジ評価基準

### カテゴリ別カバレッジ目標

| カテゴリ | パターン | 目標 | 理由 |
|---------|---------|------|------|
| **コアロジック** | \`src/domain/\`, \`src/lib/\`, \`src/core/\`, \`src/rules/\`, \`src/services/\`, \`src/usecases/\` | **100%** | ビジネス価値の源泉。バグ許容度ゼロ |
| **ユーティリティ** | \`src/utils/\`, \`src/helpers/\`, \`src/shared/\` | **90%** | 再利用されるため影響範囲大 |
| **API/コントローラ** | \`src/api/\`, \`src/controllers/\`, \`src/routes/\` | **80%** | Integrationテストと併用 |
| **UI/プレゼンテーション** | \`src/components/\`, \`src/pages/\`, \`src/views/\` | **60%** | E2Eでカバー |

### プロジェクト種別による要件

| 種別 | UT必須 | 最低カバレッジ | Integration | E2E |
|------|--------|--------------|-------------|-----|
| **library** | Yes | 80% | - | - |
| **api** | Yes | 70% | Yes | - |
| **web-app** | Yes | 60% | Yes | Yes |
| **cli** | Yes | 60% | - | - |
| **critical** (金融/決済) | Yes | 90% | Yes | Yes |

### テスト品質チェック

以下を確認してください：

1. **テストファイルの存在**
   - [ ] 各ソースファイルに対応するテストファイルがあるか
   - [ ] テストファイル命名規則: \`*.test.ts\`, \`*.spec.ts\`

2. **テストの種類**
   - [ ] Unit テスト: \`tests/unit/\` または \`src/**/__tests__/\`
   - [ ] Integration テスト: \`tests/integration/\` （API/DB連携がある場合）
   - [ ] E2E テスト: \`tests/e2e/\` （Webアプリの場合）

3. **CI設定**
   - [ ] \`.github/workflows/\` でテストが自動実行されるか
   - [ ] カバレッジレポートが生成されるか
   - [ ] カバレッジ閾値が設定されているか

4. **テストの質**
   - [ ] AAA パターン (Arrange-Act-Assert) に従っているか
   - [ ] 正常系・異常系の両方がテストされているか
   - [ ] 境界値がテストされているか
   - [ ] モックが適切に使用されているか（過剰でないか）

### 🔴 テスト不足の重大問題

以下の場合は🔴重大として報告：

- コアロジックにテストがない
- カバレッジが50%未満
- テストはあるが実際には何も検証していない（形骸化）
- CIでテストが実行されていない

---`);
    // Output format
    sections.push(`## 出力形式

### 総合評価

| 項目 | 評価 |
|------|------|
| 仕様適合性 | ⭐⭐⭐⭐⭐ (5段階) |
| コード品質 | ⭐⭐⭐⭐⭐ (5段階) |
| セキュリティ | ⭐⭐⭐⭐⭐ (5段階) |
| 運用性 | ⭐⭐⭐⭐⭐ (5段階) |
| テストカバレッジ | ⭐⭐⭐⭐⭐ (5段階) |
| **総合判定** | マージ可 / 要修正 / 差し戻し |

### 要件カバレッジ

| 要件ID | 要件内容 | 実装 | テスト | 備考 |
|--------|---------|------|-------|------|
| FR-XXX | [内容] | ✅/⚠️/❌ | ✅/⚠️/❌ | [補足] |

### 検出された問題

| # | ファイル:行 | 重大度 | カテゴリ | 問題 | 修正案 |
|---|------------|-------|---------|------|-------|
| 1 | src/xxx.ts:42 | 🔴/🟡/🟢 | セキュリティ/品質/仕様 | 具体的な問題 | 具体的な修正案 |

### 良い点

- [良い点を具体的に]

### マージ前に必要なアクション

1. [ ] [必須] 〇〇の修正
2. [ ] [推奨] 〇〇の改善

---

**レビューを開始してください。「本番環境にリリースしても問題ないか」を厳しく判定してください。**`);
    return sections.join('\n\n');
}
/**
 * Generate a design-implementation consistency review prompt
 */
export function generateDesignReviewPrompt(options) {
    const { docsDir, srcDir = './src' } = options;
    const sections = [];
    sections.push(`# 設計・実装整合性レビュー依頼

**目的**: 設計ドキュメントと実装コードが一致しているか確認する

---`);
    sections.push(`## 対象

- **設計ドキュメント**: \`${docsDir}/02-spec/02-design/\`
- **実装コード**: \`${srcDir}/\`

---`);
    sections.push(`## チェック項目

### 1. ARCHITECTURE.md との整合性

- [ ] 記載されたコンポーネントが全て実装されているか
- [ ] 依存関係が設計通りか
- [ ] 技術スタックが一致しているか
- [ ] データフローが設計通りか

### 2. CLASS.md との整合性

- [ ] クラス/インターフェースが設計通りに実装されているか
- [ ] メソッドシグネチャが一致しているか
- [ ] 型定義が一致しているか
- [ ] クラス間の関係（継承、集約等）が正しいか

### 3. API.md との整合性

- [ ] エンドポイントが設計通りに実装されているか
- [ ] リクエスト/レスポンス形式が一致しているか
- [ ] エラーコード・エラーレスポンスが一致しているか
- [ ] 認証・認可の実装が仕様通りか

### 4. ERROR-HANDLING.md との整合性

- [ ] エラーコードが定義通りに使用されているか
- [ ] エラーメッセージが一致しているか
- [ ] リトライ戦略が実装されているか

---`);
    sections.push(`## 出力形式

### 整合性マトリクス

| ドキュメント | 整合性 | 差分の詳細 |
|-------------|--------|-----------|
| ARCHITECTURE.md | ✅一致/⚠️部分一致/❌不一致 | [差分の説明] |
| CLASS.md | ✅一致/⚠️部分一致/❌不一致 | [差分の説明] |
| API.md | ✅一致/⚠️部分一致/❌不一致 | [差分の説明] |
| ERROR-HANDLING.md | ✅一致/⚠️部分一致/❌不一致 | [差分の説明] |

### 検出された差分

| # | ドキュメント | 設計内容 | 実装内容 | 対応 |
|---|-------------|---------|---------|------|
| 1 | API.md | POST /users | 未実装 | 実装追加 |
| 2 | CLASS.md | UserService.delete() | deleteUser() | ドキュメント更新 |

### 要アクション

1. **実装追加が必要**: [設計にあるが実装にないもの]
2. **ドキュメント更新が必要**: [実装にあるが設計にないもの]
3. **設計見直しが必要**: [設計自体に問題があるもの]

---

**レビューを開始してください。**`);
    return sections.join('\n\n');
}
//# sourceMappingURL=review-prompt.js.map